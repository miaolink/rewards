// 关键词列表 - 从keyword.txt文件中提取
const keywords = [
  "豫章故郡", "洪都新府", "星分翼轸", "地接衡庐", "襟三江而带五湖",
  "控蛮荆而引瓯越", "物华天宝", "龙光射牛斗之墟", "人杰地灵", "徐孺下陈蕃之榻",
  "雄州雾列", "俊采星驰", "台隍枕夷夏之交", "宾主尽东南之美", "都督阎公之雅望",
  "棨戟遥临", "宇文新州之懿范", "襜帷暂驻", "十旬休假", "胜友如云",
  "千里逢迎", "高朋满座", "腾蛟起凤", "孟学士之词宗", "紫电青霜",
  "王将军之武库", "家君作宰", "路出名区", "童子何知", "躬逢胜饯",
  "时维九月", "序属三秋", "潦水尽而寒潭清", "烟光凝而暮山紫", "俨骖騑于上路",
  "访风景于崇阿", "临帝子之长洲", "得天人之旧馆", "层峦耸翠", "上出重霄",
  "飞阁流丹", "下临无地", "鹤汀凫渚", "穷岛屿之萦回", "桂殿兰宫",
  "即冈峦之体势", "披绣闼", "俯雕甍", "山原旷其盈视", "川泽纡其骇瞩",
  "闾阎扑地", "钟鸣鼎食之家", "舸舰弥津", "青雀黄龙之舳", "云销雨霁",
  "彩彻区明", "落霞与孤鹜齐飞", "秋水共长天一色", "渔舟唱晚", "响穷彭蠡之滨",
  "雁阵惊寒", "声断衡阳之浦", "遥襟甫畅", "逸兴遄飞", "爽籁发而清风生",
  "纤歌凝而白云遏", "睢园绿竹", "气凌彭泽之樽", "邺水朱华", "光照临川之笔",
  "四美具", "二难并", "穷睇眄于中天", "极娱游于暇日", "天高地迥",
  "觉宇宙之无穷", "兴尽悲来", "识盈虚之有数", "望长安于日下", "目吴会于云间",
  "地势极而南溟深", "天柱高而北辰远", "关山难越", "谁悲失路之人", "萍水相逢",
  "尽是他乡之客", "怀帝阍而不见", "奉宣室以何年", "嗟乎", "时运不齐",
  "命途多舛", "冯唐易老", "李广难封", "屈贾谊于长沙", "非无圣主",
  "窜梁鸿于海曲", "岂乏明时", "所赖君子见机", "达人知命", "老当益壮",
  "宁移白首之心", "穷且益坚", "不坠青云之志", "酌贪泉而觉爽", "处涸辙以犹欢",
  "北海虽赊", "扶摇可接", "东隅已逝", "桑榆非晚", "孟尝高洁",
  "空余报国之情", "阮籍猖狂", "岂效穷途之哭", "勃", "三尺微命",
  "一介书生", "无路请缨", "等终军之弱冠", "有怀投笔", "慕宗悫之长风",
  "舍簪笏于百龄", "奉晨昏于万里", "非谢家之宝树", "接孟氏之芳邻",
  "他日趋庭", "叨陪鲤对", "今兹捧袂", "喜托龙门", "杨意不逢",
  "抚凌云而自惜", "钟期既遇", "奏流水以何惭", "呜呼", "胜地不常",
  "盛筵难再", "兰亭已矣", "梓泽丘墟", "临别赠言", "幸承恩于伟饯",
  "登高作赋", "是所望于群公", "敢竭鄙怀", "恭疏短引", "一言均赋",
  "四韵俱成", "请洒潘江", "各倾陆海云尔",
  
  // 新增关键词 - 科技类
  "人工智能", "机器学习", "深度学习", "神经网络", "大数据",
  "云计算", "区块链", "物联网", "5G技术", "虚拟现实",
  "增强现实", "量子计算", "边缘计算", "微服务", "容器化",
  "DevOps", "CI/CD", "API网关", "负载均衡", "数据库优化",
  "缓存策略", "消息队列", "分布式系统", "高可用架构", "安全防护",
  "加密算法", "身份认证", "权限管理", "日志监控", "性能调优",
  
  // 新增关键词 - 编程语言
  "JavaScript", "Python", "Java", "C++", "C#",
  "Go语言", "Rust", "Swift", "Kotlin", "TypeScript",
  "PHP", "Ruby", "Scala", "Haskell", "Erlang",
  "Dart", "R语言", "MATLAB", "Perl", "Lua",
  
  // 新增关键词 - 框架和库
  "React", "Vue.js", "Angular", "Node.js", "Express",
  "Django", "Flask", "Spring Boot", "Laravel", "ASP.NET",
  "TensorFlow", "PyTorch", "Scikit-learn", "Pandas", "NumPy",
  "Bootstrap", "Tailwind CSS", "Material-UI", "Ant Design", "Element UI",
  
  // 新增关键词 - 数据库
  "MySQL", "PostgreSQL", "MongoDB", "Redis", "Elasticsearch",
  "Cassandra", "DynamoDB", "SQLite", "Oracle", "SQL Server",
  "Neo4j", "InfluxDB", "TimescaleDB", "ClickHouse", "HBase",
  
  // 新增关键词 - 工具和平台
  "Docker", "Kubernetes", "Jenkins", "GitLab", "GitHub",
  "AWS", "Azure", "Google Cloud", "阿里云", "腾讯云",
  "VSCode", "IntelliJ IDEA", "Eclipse", "Sublime Text", "Vim",
  "Postman", "Swagger", "Jira", "Confluence", "Slack",
  
  // 新增关键词 - 算法和数据结构
  "排序算法", "搜索算法", "动态规划", "贪心算法", "回溯算法",
  "分治算法", "图论算法", "字符串匹配", "哈希表", "二叉树",
  "红黑树", "B树", "堆", "栈", "队列",
  "链表", "数组", "矩阵", "图", "并查集",
  
  // 新增关键词 - 设计模式
  "单例模式", "工厂模式", "观察者模式", "策略模式", "装饰器模式",
  "适配器模式", "代理模式", "命令模式", "状态模式", "模板方法模式",
  "建造者模式", "原型模式", "外观模式", "组合模式", "桥接模式",
  
  // 新增关键词 - 网络和安全
  "HTTP协议", "HTTPS", "TCP/IP", "DNS", "CDN",
  "负载均衡", "反向代理", "防火墙", "VPN", "SSL证书",
  "OAuth2.0", "JWT", "CORS", "XSS攻击", "SQL注入",
  "CSRF攻击", "DDoS防护", "数据加密", "密钥管理", "安全审计",
  
  // 新增关键词 - 移动开发
  "iOS开发", "Android开发", "React Native", "Flutter", "Xamarin",
  "移动应用", "原生开发", "混合开发", "跨平台", "应用商店",
  "推送通知", "地理位置", "相机功能", "蓝牙连接", "NFC技术",
  
  // 新增关键词 - 游戏开发
  "Unity3D", "Unreal Engine", "Cocos2d", "游戏引擎", "物理引擎",
  "3D建模", "动画制作", "音效设计", "游戏策划", "关卡设计",
  "多人游戏", "网络同步", "游戏AI", "碰撞检测", "粒子系统",
  
  // 新增关键词 - 数据科学
  "数据挖掘", "统计分析", "数据可视化", "机器学习算法", "深度学习模型",
  "自然语言处理", "计算机视觉", "推荐系统", "预测分析", "异常检测",
  "特征工程", "模型评估", "超参数调优", "数据清洗", "数据预处理",
  
  // 新增关键词 - 运维和监控
  "系统监控", "日志分析", "性能监控", "告警系统", "自动化部署",
  "配置管理", "版本控制", "备份恢复", "灾难恢复", "容量规划",
  "服务网格", "API管理", "微服务治理", "容器编排", "云原生",
  
  // 新增关键词 - 前端技术
  "HTML5", "CSS3", "ES6+", "Webpack", "Babel",
  "Sass", "Less", "Web Components", "PWA", "Service Worker",
  "WebAssembly", "Canvas", "WebGL", "WebRTC", "WebSocket",
  
  // 新增关键词 - 后端技术
  "RESTful API", "GraphQL", "gRPC", "消息队列", "任务调度",
  "缓存策略", "数据库设计", "ORM框架", "事务管理", "并发控制",
  "异步编程", "事件驱动", "微服务架构", "服务发现", "配置中心",
  
  // 新增关键词 - 测试和质量
  "单元测试", "集成测试", "端到端测试", "性能测试", "安全测试",
  "自动化测试", "测试驱动开发", "持续集成", "代码审查", "静态分析",
  "代码覆盖率", "测试报告", "缺陷管理", "质量保证", "用户体验测试",
  
  // 新增关键词 - 项目管理
  "敏捷开发", "Scrum", "看板方法", "用户故事", "冲刺计划",
  "产品需求", "技术方案", "架构设计", "风险评估", "资源管理",
  "进度跟踪", "团队协作", "沟通管理", "变更管理", "发布管理",
  
  // 新增关键词 - 行业应用
  "电子商务", "在线教育", "金融科技", "医疗健康", "智慧城市",
  "物联网应用", "智能制造", "数字营销", "内容管理", "客户关系管理",
  "企业资源规划", "供应链管理", "人力资源管理", "财务管理", "项目管理",
  
  // 新增关键词 - 新兴技术
  "元宇宙", "Web3.0", "NFT", "DeFi", "智能合约",
  "数字孪生", "边缘AI", "联邦学习", "生成式AI", "大语言模型",
  "自动驾驶", "无人机技术", "机器人技术", "生物识别", "量子通信",
  
  // 新增关键词 - 学术研究
  "计算机科学", "软件工程", "信息论", "算法复杂度", "计算理论",
  "形式化方法", "软件验证", "程序分析", "编译器设计", "操作系统",
  "计算机网络", "分布式计算", "并行计算", "高性能计算", "量子计算理论",
  
  // 新增关键词 - 实用工具
  "正则表达式", "Shell脚本", "批处理", "PowerShell", "Linux命令",
  "Git操作", "Docker命令", "Kubernetes命令", "数据库查询", "网络诊断",
  "性能分析", "内存管理", "垃圾回收", "线程安全", "并发编程",
  
  // 新增关键词 - 开发实践
  "代码规范", "设计原则", "重构技术", "设计模式应用", "最佳实践",
  "架构模式", "SOLID原则", "DRY原则", "KISS原则", "YAGNI原则",
  "代码可读性", "可维护性", "可扩展性", "可测试性", "性能优化",
  
  // 新增关键词 - 热门话题
  "数字化转型", "云原生应用", "无服务器架构", "事件驱动架构", "API优先设计",
  "数据驱动决策", "实时数据处理", "流式计算", "批处理", "数据湖",
  "数据仓库", "商业智能", "数据治理", "数据安全", "隐私保护",
  
  // 新增关键词 - 编程概念
  "面向对象", "函数式编程", "响应式编程", "声明式编程", "命令式编程",
  "元编程", "反射机制", "依赖注入", "控制反转", "面向切面编程",
  "泛型编程", "模板编程", "元数据", "注解", "装饰器",
  
  // 新增关键词 - 系统架构
  "单体架构", "微服务架构", "事件驱动架构", "CQRS模式", "事件溯源",
  "领域驱动设计", "六边形架构", "洋葱架构", "清洁架构", "分层架构",
  "MVC模式", "MVP模式", "MVVM模式", "前后端分离", "API网关模式",
  
  // 新增关键词 - 性能优化
  "缓存优化", "数据库优化", "查询优化", "索引优化", "内存优化",
  "CPU优化", "网络优化", "前端优化", "后端优化", "全栈优化",
  "负载测试", "压力测试", "容量规划", "性能监控", "性能调优",
  
  // 新增关键词 - 安全防护
  "身份认证", "授权管理", "访问控制", "数据加密", "传输加密",
  "存储加密", "密钥管理", "证书管理", "安全审计", "漏洞扫描",
  "渗透测试", "安全编码", "安全架构", "威胁建模", "风险评估",
  
  // 新增关键词 - 开发工具链
  "构建工具", "包管理器", "依赖管理", "版本控制", "代码托管",
  "持续集成", "持续部署", "自动化测试", "代码质量", "静态分析",
  "动态分析", "性能分析", "内存分析", "调试工具", "监控工具",
  
  // 新增关键词 - 云服务
  "云存储", "云数据库", "云函数", "容器服务", "负载均衡",
  "CDN加速", "对象存储", "文件存储", "块存储", "数据库服务",
  "消息服务", "缓存服务", "搜索服务", "监控服务", "日志服务",
  
  // 新增关键词 - 大数据技术
  "Hadoop", "Spark", "Flink", "Kafka", "Storm",
  "Hive", "HBase", "Zookeeper", "YARN", "MapReduce",
  "数据流处理", "批流一体", "实时计算", "离线计算", "数据湖",
  
  // 新增关键词 - 人工智能应用
  "图像识别", "语音识别", "自然语言处理", "机器翻译", "情感分析",
  "文本分类", "命名实体识别", "问答系统", "对话系统", "推荐算法",
  "异常检测", "预测分析", "聚类分析", "关联规则", "决策树",
  
  // 新增关键词 - 移动互联网
  "移动应用开发", "小程序开发", "H5开发", "混合应用", "原生应用",
  "移动端优化", "响应式设计", "移动端测试", "应用分发", "应用商店优化",
  "推送服务", "地理位置服务", "支付集成", "社交分享", "第三方登录",
  
  // 新增关键词 - Web技术
  "Web开发", "前端框架", "后端框架", "全栈开发", "响应式Web设计",
  "渐进式Web应用", "单页应用", "多页应用", "Web组件", "Web API",
  "浏览器兼容性", "跨域问题", "前端路由", "状态管理", "数据绑定",
  
  // 新增关键词 - 数据库技术
  "关系型数据库", "非关系型数据库", "分布式数据库", "时序数据库", "图数据库",
  "数据库设计", "数据建模", "数据迁移", "数据备份", "数据恢复",
  "数据库优化", "查询优化", "索引设计", "事务管理", "并发控制",
  
  // 新增关键词 - 网络技术
  "网络协议", "网络架构", "网络优化", "网络监控", "网络安全",
  "网络编程", "Socket编程", "HTTP客户端", "WebSocket", "网络诊断",
  "网络配置", "网络管理", "网络故障排除", "网络性能", "网络容量规划",
  
  // 新增关键词 - 操作系统
  "Linux系统", "Windows系统", "macOS系统", "Unix系统", "嵌入式系统",
  "系统管理", "进程管理", "内存管理", "文件系统", "设备驱动",
  "系统调用", "内核编程", "系统编程", "系统优化", "系统监控",
  
  // 新增关键词 - 编译原理
  "编译器设计", "解释器设计", "词法分析", "语法分析", "语义分析",
  "代码生成", "代码优化", "链接器", "加载器", "虚拟机",
  "字节码", "中间表示", "抽象语法树", "符号表", "错误处理",
  
  // 新增关键词 - 软件工程
  "需求分析", "系统设计", "详细设计", "编码实现", "单元测试",
  "集成测试", "系统测试", "验收测试", "部署发布", "维护支持",
  "版本管理", "配置管理", "变更管理", "风险管理", "质量管理",
  
  // 新增关键词 - 项目管理
  "项目计划", "项目执行", "项目监控", "项目控制", "项目收尾",
  "范围管理", "时间管理", "成本管理", "质量管理", "人力资源管理",
  "沟通管理", "风险管理", "采购管理", "干系人管理", "项目组合管理",
  
  // 新增关键词 - 团队协作
  "代码审查", "结对编程", "团队编程", "知识分享", "技术培训",
  "团队建设", "沟通技巧", "冲突解决", "领导力", "团队管理",
  "敏捷实践", "Scrum实践", "看板实践", "持续改进", "团队文化",
  
  // 新增关键词 - 职业发展
  "技术成长", "技能提升", "知识学习", "经验积累", "职业规划",
  "技术路线", "发展方向", "能力建设", "价值创造", "影响力提升",
  "技术分享", "开源贡献", "技术写作", "技术演讲", "技术社区",
  
  // 新增关键词 - 行业趋势
  "技术趋势", "发展方向", "创新技术", "新兴领域", "市场机会",
  "技术变革", "数字化转型", "智能化升级", "云化迁移", "微服务化",
  "容器化部署", "DevOps实践", "敏捷转型", "精益管理", "持续交付",
  
  // 新增关键词 - 实用技能
  "问题解决", "逻辑思维", "分析能力", "学习能力", "适应能力",
  "创新能力", "沟通能力", "协作能力", "领导能力", "管理能力",
  "时间管理", "压力管理", "情绪管理", "自我管理", "目标管理",
  
  // 新增关键词 - 工具使用
  "IDE使用", "调试技巧", "版本控制", "构建部署", "监控运维",
  "性能调优", "安全防护", "数据备份", "故障排除", "系统维护",
  "工具链集成", "自动化脚本", "配置管理", "环境管理", "资源管理",
  
  // 新增关键词 - 最佳实践
  "编码规范", "设计原则", "架构模式", "开发流程", "测试策略",
  "部署策略", "监控策略", "安全策略", "备份策略", "恢复策略",
  "性能优化", "安全加固", "代码重构", "技术债务", "技术选型",
  
  // 新增关键词 - 常见问题
  "性能问题", "内存泄漏", "死锁问题", "并发问题", "网络问题",
  "数据库问题", "缓存问题", "安全漏洞", "兼容性问题", "用户体验问题",
  "系统稳定性", "可用性问题", "扩展性问题", "维护性问题", "升级问题",
  
  // 新增关键词 - 解决方案
  "架构设计", "技术方案", "实现方案", "优化方案", "迁移方案",
  "升级方案", "扩容方案", "备份方案", "恢复方案", "监控方案",
  "安全方案", "测试方案", "部署方案", "运维方案", "管理方案",
  
  // 新增关键词 - 技术深度
  "底层原理", "核心机制", "实现细节", "性能特性", "安全机制",
  "扩展机制", "兼容机制", "错误处理", "异常处理", "边界情况",
  "极端场景", "压力测试", "稳定性测试", "可靠性测试", "安全性测试",
  
  // 新增关键词 - 技术广度
  "技术栈", "技术生态", "技术选型", "技术对比", "技术评估",
  "技术调研", "技术预研", "技术验证", "技术推广", "技术培训",
  "技术分享", "技术交流", "技术合作", "技术咨询", "技术支持",
  
  // 新增关键词 - 业务理解
  "业务需求", "业务逻辑", "业务流程", "业务规则", "业务模型",
  "业务分析", "业务设计", "业务实现", "业务测试", "业务部署",
  "业务监控", "业务优化", "业务扩展", "业务维护", "业务支持",
  
  // 新增关键词 - 用户体验
  "界面设计", "交互设计", "视觉设计", "用户体验", "可用性",
  "易用性", "可访问性", "响应式设计", "移动端适配", "浏览器兼容",
  "性能体验", "加载速度", "操作流畅", "错误提示", "帮助文档",
  
  // 新增关键词 - 数据管理
  "数据采集", "数据清洗", "数据转换", "数据加载", "数据存储",
  "数据查询", "数据分析", "数据挖掘", "数据可视化", "数据报告",
  "数据质量", "数据安全", "数据隐私", "数据治理", "数据管理",
  
  // 新增关键词 - 系统集成
  "API集成", "系统对接", "数据同步", "消息传递", "事件处理",
  "工作流", "业务流程", "集成测试", "接口测试", "端到端测试",
  "系统联调", "环境配置", "部署协调", "监控集成", "日志集成",
  
  // 新增关键词 - 运维管理
  "系统部署", "环境管理", "配置管理", "版本管理", "发布管理",
  "监控告警", "日志管理", "备份恢复", "故障处理", "性能调优",
  "容量规划", "安全管理", "权限管理", "审计管理", "合规管理",
  
  // 新增关键词 - 质量保证
  "代码质量", "测试质量", "产品质量", "服务质量", "用户体验质量",
  "性能质量", "安全质量", "可靠性质量", "可用性质量", "可维护性质量",
  "质量评估", "质量改进", "质量监控", "质量报告", "质量保证",
  
  // 新增关键词 - 风险管理
  "技术风险", "项目风险", "业务风险", "安全风险", "合规风险",
  "运营风险", "市场风险", "财务风险", "人员风险", "环境风险",
  "风险评估", "风险控制", "风险监控", "风险报告", "风险管理",
  
  // 新增关键词 - 成本控制
  "开发成本", "运维成本", "硬件成本", "软件成本", "人力成本",
  "时间成本", "机会成本", "沉没成本", "边际成本", "总拥有成本",
  "成本分析", "成本控制", "成本优化", "成本监控", "成本管理",
  
  // 新增关键词 - 效率提升
  "开发效率", "测试效率", "部署效率", "运维效率", "管理效率",
  "沟通效率", "协作效率", "学习效率", "决策效率", "执行效率",
  "效率分析", "效率改进", "效率优化", "效率监控", "效率管理",
  
  // 新增关键词 - 创新驱动
  "技术创新", "产品创新", "服务创新", "模式创新", "管理创新",
  "流程创新", "工具创新", "方法创新", "思维创新", "文化创新",
  "创新思维", "创新能力", "创新实践", "创新成果", "创新管理",
  
  // 新增关键词 - 持续改进
  "过程改进", "质量改进", "效率改进", "服务改进", "产品改进",
  "技术改进", "管理改进", "流程改进", "工具改进", "方法改进",
  "改进计划", "改进实施", "改进评估", "改进监控", "改进管理",
  
  // 新增关键词 - 知识管理
  "知识获取", "知识整理", "知识存储", "知识分享", "知识应用",
  "知识创新", "知识保护", "知识传播", "知识传承", "知识更新",
  "知识库建设", "知识管理系统", "知识图谱", "知识挖掘", "知识服务",
  
  // 新增关键词 - 能力建设
  "技术能力", "业务能力", "管理能力", "沟通能力", "协作能力",
  "学习能力", "创新能力", "解决问题能力", "决策能力", "执行能力",
  "能力评估", "能力提升", "能力发展", "能力认证", "能力管理",
  
  // 新增关键词 - 价值创造
  "技术价值", "业务价值", "用户价值", "社会价值", "经济价值",
  "战略价值", "战术价值", "长期价值", "短期价值", "直接价值",
  "间接价值", "潜在价值", "显性价值", "隐性价值", "综合价值",
  
  // 新增关键词 - 成功要素
  "技术实力", "团队协作", "项目管理", "质量保证", "用户需求",
  "市场机会", "资源投入", "时间管理", "风险控制", "持续改进",
  "创新思维", "执行力", "沟通能力", "学习能力", "适应能力",
  
  // 新增关键词 - 挑战应对
  "技术挑战", "业务挑战", "市场挑战", "竞争挑战", "环境挑战",
  "人员挑战", "资源挑战", "时间挑战", "质量挑战", "成本挑战",
  "挑战识别", "挑战分析", "挑战应对", "挑战监控", "挑战管理",
  
  // 新增关键词 - 未来展望
  "技术发展", "行业趋势", "市场前景", "发展机遇", "创新方向",
  "技术演进", "产品升级", "服务优化", "模式创新", "生态建设",
  "未来规划", "战略布局", "能力建设", "价值创造", "持续发展"
];

let isSearching = false;
let searchInterval = null;
let currentProgress = { current: 0, total: 0 };
let currentUrlSuffix = '';

// 随机打乱关键词数组
function shuffleKeywords() {
  const shuffled = [...keywords];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// 生成完整的搜索URL
function generateSearchUrl(keyword, urlSuffix = '') {
  const baseUrl = `https://www.bing.com/search?q=${encodeURIComponent(keyword)}`;
  
  // 如果用户提供了URL补充参数，则添加到URL中
  if (urlSuffix && urlSuffix.trim()) {
    // 确保补充参数以&开头
    const suffix = urlSuffix.trim().startsWith('&') ? urlSuffix.trim() : `&${urlSuffix.trim()}`;
    return baseUrl + suffix;
  }
  
  return baseUrl;
}

// 执行搜索
async function performSearch(keyword, searchCount, interval, urlSuffix) {
  if (!isSearching) return;

  try {
    // 生成完整的搜索URL
    const searchUrl = generateSearchUrl(keyword, urlSuffix);
    
    console.log(`执行搜索: ${searchUrl}`);
    
    // 创建新标签页进行搜索
    const tab = await chrome.tabs.create({ url: searchUrl, active: false });
    
    // 等待页面加载
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // 关闭标签页
    await chrome.tabs.remove(tab.id);
    
    currentProgress.current++;
    
    // 更新进度
    chrome.runtime.sendMessage({
      action: 'updateProgress',
      current: currentProgress.current,
      total: currentProgress.total
    });
    
    // 检查是否完成
    if (currentProgress.current >= currentProgress.total) {
      isSearching = false;
      chrome.runtime.sendMessage({ action: 'searchComplete' });
      return;
    }
    
    // 继续下一次搜索
    if (isSearching) {
      setTimeout(() => {
        const nextKeyword = shuffledKeywords[currentProgress.current];
        performSearch(nextKeyword, searchCount, interval, urlSuffix);
      }, interval * 1000);
    }
    
  } catch (error) {
    console.error('搜索出错:', error);
    chrome.runtime.sendMessage({ 
      action: 'searchError', 
      error: error.message 
    });
    isSearching = false;
  }
}

let shuffledKeywords = [];

// 监听来自popup的消息
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'startSearch') {
    if (isSearching) {
      sendResponse({ success: false, message: '搜索已在进行中' });
      return;
    }
    
    isSearching = true;
    currentProgress = { current: 0, total: request.searchCount };
    currentUrlSuffix = request.urlSuffix || '';
    shuffledKeywords = shuffleKeywords().slice(0, request.searchCount);
    
    console.log(`开始搜索，参数:`, {
      searchCount: request.searchCount,
      searchInterval: request.searchInterval,
      urlSuffix: currentUrlSuffix
    });
    
    // 开始第一次搜索
    const firstKeyword = shuffledKeywords[0];
    performSearch(firstKeyword, request.searchCount, request.searchInterval, currentUrlSuffix);
    
    sendResponse({ success: true });
    
  } else if (request.action === 'stopSearch') {
    isSearching = false;
    sendResponse({ success: true });
    
  } else if (request.action === 'getStatus') {
    sendResponse({
      isSearching: isSearching,
      progress: currentProgress
    });
  }
});

// 插件安装时的初始化
chrome.runtime.onInstalled.addListener(() => {
  console.log('Bing Rewards Auto Search 插件已安装');
  
  // 设置默认的URL补充参数
  chrome.storage.local.get(['urlSuffix'], function(result) {
    if (!result.urlSuffix) {
      chrome.storage.local.set({
        urlSuffix: '&qs=HS&sk=HS3&sc=8-0&cvid=8130CC689B484DB3BDB96687EFD44C65&FORM=QBLH&sp=4&lq=0'
      });
    }
  });
}); 